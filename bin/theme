#!/usr/bin/env bash

if [ $1 ]; then
    selected_theme=$1
    if [[ ! -d "$HOME/dotfiles/themes/$selected_theme" ]]; then
        echo "Theme '$selected_theme' not found"
        exit 1
    fi
else
    selected_theme=$(ls -1 "$HOME/dotfiles/themes" | grep -v '^current$' | fzf)
    if [ $? -ne 0 ]; then
        exit 0
    fi
fi

if [ $selected_theme == "current" ]; then
    exit 0
fi

rm "$HOME/dotfiles/themes/current" && \
    ln -s $selected_theme "$HOME/dotfiles/themes/current" 


function reload_nvim() {
    servers=$(nvr --serverlist)
    if [ -n "$servers" ]; then
        for server in $servers; do
            nvr --servername "$server" --nostart -s -c 'source ~/.config/nvim/init.lua'
        done
    fi
}

function reload_ghostty() {
    find ~/Library/Application\ Support/com.mitchellh.ghostty ~/.config/ghostty 2>/dev/null\
        | entr pkill -SIGUSR2 ghostty &2>/dev/null
}

function reload_tmux() {
    tmux source-file "$HOME/dotfiles/config/tmux/tmux.conf"
}

reload_nvim & \
    reload_ghostty & \
    reload_tmux & \
    wait
